<!DOCTYPE html>
<HTML>
	<HEAD>
		<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
		<TITLE>microSmartHome</TITLE>
	</HEAD>
	<BODY>
		<H2>microSmartHome</H2>
		<!-- foreword -->
        <div>
            <h3> Устройство умного дома.<br><br> Общее описание.</h3>
            <div>
                Данное устройство измеряет температуру, имеет датчик движения и определяет наличие напряжения
                в сети. Работает как от сети 220В так и от батарейного питания от3.5В до 5В
                (проще взять литиевую батарею). Модуль SIM900 обеспечивает связь по мобильной сети.
            </div>
            <span class="label">Что измеряется:</span>
            <ol> 
                <li>
                    Измеряет температуру. Где установить - там и измерит (комната, отопительный котёл,
                    теплица и т.п.)
                </li>
                <li>
                    Если подключить датчик движения, то определит количество перемещений в своей зоне
                    обнаружения.
                </li>
                <li>
                    При питании от сетевого источника определит момент исчезновения напряжения.
                </li>
            </ol>
            <span class="label">Настройки:</span>
            <ol>
                <li>
                    Назначается администратор устройства. Адмиистратор может задать ниже указанные
                    настройки и назначить ещё двух клиентов для отправки смс сообщений. Клиенты
                    только принимают сообщения. 
                </li>
                <li>
                    Устанавливается(настраивается) минимаальное значение температуры.
                </li>
                <li>
                    Задаётся реагировать или нет на движение.
                </li>
            </ol>
            <span class="label">СМС:</span>
            <ol>
                <li>
                    Если задано минимальное значение температуры, будет отправлено смс сообщение при
                    значении температуры менее установленного. Сообщение отправится администратору и
                    клиентам(если они есть).
                </li>
                <li>
                    С датчиком движения аналогично.
                </li>
                <li>
                    Если пропадёт напряжение в сети сообщение получит только администратор.
                </li>
            </ol>
            <span class="label">Голосовые вызовы(звонки):</span>
            <ol>
                <li>
                    Если позвонить на номер модуля. Он ответит какая на данный момент температура и
                    сообщит о наличии движения.
                </li>
            </ol>
            <span class="label">Отправка данных через интернет.(GPRS соединение):</span>
            <ol>
                <li>
                    Модуль может отправлять данные на серевер ThingSpeak. Для этого надо зарегистрироваться
                    и создать канал для передачи данных. 
                </li>
                <li>
                    Введите ключ записи данных сервера(WRITE_API_KEY) и презагрузите
                    модуль. После перезагрузки он начнёт передавать данные на ThingSpeak.           
                </li>
            </ol>
            <hr width="60%">
            <div>
                Назначение: отправка данных с удалённых объектов.
				<h5><u>Функционал.</u></h5>
				<ol>
					<li>Устройство можно настроить.</li>
					<li>
						При снижении температуры менее минимальной, обнаружении движения,
						исчезновении сетевого напряжения по назначенным телефонным номерам будет отправлено смс
						сообщение.
					</li>
					<li>
						При звонке, устройство передаст текущие значения параметров.
					</li>
					<li>
						Если установлено значение ключа с сервера ThingSpeak (write_api_key),
						то каждые пять минут данные будут отправляться на сервер.
					</li>
				</ol>
            </div>
        </div>
        <div>
            <h3> Подробности.</h3>
            <span class="label">
				Схема устройства:<br>				
			</span>
			<img src="sheet.png" alt="схема модуля"><br>
			<!-- sheet with notes -->
			<div>
				<h4>Замечания по схеме:</h4>
				<ul>
					<li>
						Диоды D1, D2 желательно взять Шоттки обратное напряжение 20В(можно больше).
						Нужны для того, чтобы не пропускать напряжение батареи к пину а0, измеряющему
						наличие напряжения на внешнем источнике. Если планируется работа только от
						батарей можно убрать диоды , сопротивление R7 и часть схемы идущую от разъёма "power", а
						пином а0, при необходимости, измерять напряжение. Для такого случая в Constants.h надо найти строку
						"#define READ_AS_ANALOG 0" и заменить 0 на 1 и всё перекомпилировать. Прочитанные значения
						будут изменяться от 0 до 255 пропорционально напряжению на пине а0(5В - 255, 0В - 0), смс
						отправляться не будут, данные на ThingSpeak будут отправляться в соответствии с настройками устройства.
						<br><u>При питании только от сети диоды тоже не нужны.</u>
					</li>
					<li>
						Если датчик движения не нужен его можно выкинуть из схемы. <b>Сопротивление R8 удалять не стоит.</b>
						Хоть пин программно подтянут к земле, но кто его знает?
					</li>
					<li>
						Транзистор Q1 - Любой mosfet low серии( открывается при напряжении менее 4В ) на ток не менее 5А. 
					</li>
					<li>
						Конденсаторы C2 - фильтр вч помех. С1 - накопительный, если стоит, то устройство сможет работать
						от сетевого источника на 5В и 0.5А без батарей.
					</li>
				</ul>
			</div>
			<!-- prepare for work -->
			<h3><u>Предварительные действия</u></h3>
			<div>Place for hard prepare</div>
			<div>
				Устройство имеет три режима работы - duct , test, work.
				<ol>
					<li>
						DUCT - режим связи с SIM 900. В этом режиме Arduino  играет роль моста между компьютером
						и SIM 900. Подключаем Arduino к компьютеру и весь ввод с компьютера передаётся модулю. После перехода
						 в этот режим эхо будет отключено и сообщения от модема не выводятся. Для проверки ввести AT. Если
						 всё нормально в окне вывода будет переход на нолвую строку. Если надо смотреть ответы модуля - нужно
						 включить  эхо на SIM 900 командой ATE1. При выходе из DUCT <b style="color:#b01040;">обязательно</b> отключить
						 эхо - ATE0(последний ноль).
					</li>
					<li>
						TEST - в этом режиме в serial выводится дополнительная отладочная информация и команды,
						переданные модему.
					</li>
					<li>
						WORK - нормальный режим работы.
					</li>
					<li>
						Помимо этого, если замкнуть выключатель SW2, то модуль перестаёт отправлять СМС сообщения.
					</li>
				</ol>
				<big>Выбор режима.</big>
				<ul>
					<li>
						На компьютере открываем программу связи по последовательному порту.( Minicom, Cutecom,
						Pytty и т.п.). Замкнуть контакты SW2 на модуле.
					</li>
					<li>
						Подключаем Ардуино к компьютеру USB шнуром и подаём питание на модуль. Последовательность не важна.
					</li>
					<li>
						Ждём прохождения инициализации. О окончании можно судить по выводу<br>
						<em>"handleIncomingSms "</em><br>
						И через несколько секунд закрывающейся скобки ")".
					</li>
					<li>
						Далее жмём на кнопку SW1 немного ждём и отпускаем. С первого раза может не получиться, тогда жмём ещё.
						При переходе из режима в режим будут появляться сообщения о том, какой режим включен.<br>
						Примечание: нажатие на кнопку обрабатывается последовательно с остальными событиями, если модуль
						занят ответа может и не быть, поэтому может потребоваться повторное нажатие.
					</li>
				</ul>
			</div>
			<div>
				<h4>Работа с последовательным портом - <u><em>serial</em></u></h4>
				<div>
					Для взаимодействи с модулем SIM 900 используется serial port, по которому отправляются команды модему, назначаются
					значения свойств и т.п. Это работает в режиме DUCT. Самый простой способ связи - использовать встроенный в
					Arduino ide  Serial monitor. Либо Cutecom, Minicom и т.п. <br>
					Скорость выставить 9600, символ окончания - LF И CR. Мне понравился Cutecom с его
					возможностью передачи не только комманд но и файлов.
				</div>
				<div>
				
				</div>
			</div>
			<!--  admin and it capability -->
			<div>
				<h4>Назначение администратора</h4>
				<ul>
					<li>
						Предварительно вставить sim карту модуля в телефон и очистить тел. книгу.
					</li>
					<li>
						<em>Способ 1</em> - включить модуль, дождаться активации. Если включен <em>serial monitor</em> надо дождаться
						строки <em>"handleIncomingSms "</em> и подождать несколькь секунд до появления 
						закрывающей круглой скобки ")" или ,если serial не подлючен, подождать минуты 4. После активации зажать
						sw1(кнопка) и позвонить на номер модуля. Звонивший автоматически назначается администратором.
					</li>
					<li>
						<em>Способ 2</em> - назначить через "serial port". Перейти в DUCT режим и ввести команду:<br>
						<b>AT+CPBW=1,"+71234567890",145,"+7_admin_number"</b><br>
						Здесь <em>"+71234567890" и "+7_admin_number"</em> номер телефона отправляющего команды модулю
						(телефон администратора). Кавычки в команде обязательны.<br>
						После вернуться в нормальный режим и отключть SW2.
					</li>
				</ul>
				<h4>Администратор отсылает команды модулю в СМС сообщениях.</h4>
				<big>Команды.</big>
				<ol>
					<li>
						#w#num#тел_номер# - назначить телефоны. На указанные номера будут приходить
						СМС сообщения о пониженной температуре и, если задано, о срабатывании датчика движения.
						<ol>
							<li>
								Формат номеров международный - +7........ (всего 12 символов).
							</li>
							<li>
								num - число от 1 до 3 . Это номер клиента. Клиент с номером 1 является администратором
								устройства.
							</li>
						</ol>
					</li>
					<li>
						#T#...# - Назначить минимальное значение температуры(может быть от 1 до 99). При более низких
						значениях будут отправляться СМС сообщения с частотой ~ 1 раз в 9 часов.
					</li>
					<li>
						#M#y# - отправлять СМС при срабатывании датчика движения.<br>
						#M#n# - не отправлять.<br>
					</li>
				</ol>
				Замечание: в командах все символы латинские.<b>Номера клиентов только 1,2,3</b> если взять другие
				придётся начинать настраивать модуль заново(начнёт глючить не по дедски). Если администратор уже назначен
				, то первого клиента не назначаем(он уже есть).
			</div>
			<!--  ThingSpeak  -->
			<div>
				<h4>Отправка значений в интернет.</h4>
				<ol>
					<li>
						Для отправки данных на сайт ThingSpeak надо зарегистрироваться и создать канал.
						Канал должен иметь три поля. Первое для температуры, второе для датчика движения,
						третье для определения наличия внешнего напряжения.
					</li>
					<li>
						Подготовка модуля сводится к введению пароля записи на сайт ThingSpeak. На сайте
						обозначается как WRITE_API_KEY. По СМС этого не сделать. Надо войти в DUCT режим
						и ввести команду:<br>
						<em>AT+CPBW=6,"12345",129,"#WRITE_API_KEY#"</em><BR>
						Символы решёток обязательны. <em>WRITE_API_KEY</em> точно то, что взято с сайта.
						Должно быть ровно16 символов. Если пароль введён неверно , то ....						
					</li>
					<li>
						Если создали канал, записали пароль, то как смотреть значения знаете. Если нет,
						можно установить приложение на смартфон. В магазинах приложений искать по слову
						"thingspeak".
					</li>
				</ol>
			</div>
		</div>
	</BODY>
</HTML>
















